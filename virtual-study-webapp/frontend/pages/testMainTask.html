<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Manager</title>
    <script>

      let username = "";

      function getUserName(callback) {
        const xhr = new XMLHttpRequest();
        xhr.open("GET", "/IM3180/userdata", true); // Replace with the correct path to the servlet

        xhr.onload = function () {
          if (xhr.status === 200) {
            // Parse the JSON response
            const userData = JSON.parse(xhr.responseText);

            // Set the global username variable with the retrieved data
            username = userData.userName;

            // Optionally display the username on the HTML page
            document.getElementById("userName").textContent = username;

            // Call the callback function after username is retrieved
            if (callback) callback();
          } else {
            console.error("Error fetching session data");
          }
        };

        xhr.send();
      }

        // Function to load tasks for the user
        function loadTasks() {
            fetch(`/IM3180/tasks?username=${username}`)
                .then(response => response.json())
                .then(tasks => {
                    const taskList = document.getElementById("taskList");
                    taskList.innerHTML = '';  // Clear the existing list
                    tasks.forEach(task => {
                        const listItem = document.createElement('li');
                        listItem.innerHTML = `
                            ${task.task}
                            <form class="deleteTaskForm" data-task-id="${task.taskId}" style="display:inline">
                                <button type="submit">Delete</button>
                            </form>`;
                        taskList.appendChild(listItem);
                    });

                    // Attach event listeners to delete buttons after rendering the tasks
                    document.querySelectorAll(".deleteTaskForm").forEach(form => {
                        form.addEventListener("submit", function (e) {
                            e.preventDefault();
                            deleteTask(form.dataset.taskId);
                        });
                    });
                });
        }

        // Function to handle deleting a task
        function deleteTask(taskId) {
            fetch(`/IM3180/tasks`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: new URLSearchParams({
                    task_id: taskId,
                    username: username,
                    action: "delete"
                })
            }).then(response => {
                if (response.ok) {
                    loadTasks(); // Reload tasks after deletion
                } else {
                    alert("Failed to delete task.");
                }
            });
        }

        // Function to handle adding a task
        function addTask(event) {
            event.preventDefault();
            const taskInput = document.getElementById("taskInput").value;

            fetch(`/IM3180/tasks`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: new URLSearchParams({
                    task: taskInput,
                    username: username,
                    action: "add"
                })
            }).then(response => {
                if (response.ok) {
                    document.getElementById("taskInput").value = "";  // Clear input field
                    loadTasks(); // Reload tasks after adding
                } else {
                    alert("Failed to add task.");
                }
            });
        }

        // Load tasks when the page loads
        window.onload = function () {
            getUserName(function() {
                loadTasks();  // Load tasks only after username is retrieved

                // Add event listener to the add task form
                const addTaskForm = document.getElementById("addTaskForm");
                addTaskForm.addEventListener("submit", addTask);
            });
        };
    </script>
</head>
<body>
    <h1>Set Tasks</h1>

    <h2>User: <span id="userName"></span></h2>

    <h2>Checklist:</h2>
    <ul id="taskList"></ul>

    <h3>Add a Task</h3>
    <form id="addTaskForm">
        <input type="text" id="taskInput" name="task" placeholder="Enter your task" required>
        <button type="submit">Add Task</button>
    </form>
</body>
</html>

