<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Session Input</title>
    <script src="virtual-study-webapp/scripts/jquery-3.5.1.min.js"></script>
    <script>
      let userName = "";
      let userId = "";

      window.onload = getUserInfo;

      function getUserInfo() {
        const xhr = new XMLHttpRequest();
        xhr.open("GET", "userdata", true); // Replace with the correct path to the servlet

        xhr.onload = function () {
          if (xhr.status === 200) {
            // Parse the JSON response
            const userData = JSON.parse(xhr.responseText);

            // Log the userData to check the values (optional)
            console.log(userData);

            // Set the global sessionName and sessionKey variables with the retrieved data
            userName = userData.userName;
            userId = userData.userId;

            // Optionally display the sessionName and sessionPassword on the HTML page
            document.getElementById("userName").textContent = userName;
            document.getElementById("userName").textContent += " " + userId;

            // Log the updated sessionName and sessionKey (optional)
            console.log("Retrieved userName: ", userName);
          } else {
            console.error("Error fetching session data");
          }
        };

        xhr.send();
      }

      function sendRoomData(event) {
        event.preventDefault(); // Prevent form submission

        const sessionName = document.getElementById("sessionName").value;
        const sessionPassword =
          document.getElementById("sessionPassword").value;
        const userName = document.getElementById("userName").innerHTML;

        // Create private room
        if (document.getElementById("privateRoomCheckBox").checked) {
          // Create an AJAX request
          const xhr = new XMLHttpRequest();
          xhr.open("POST", "createprivateroom", true);
          xhr.setRequestHeader(
            "Content-Type",
            "application/x-www-form-urlencoded"
          );

          xhr.onload = function () {
            if (xhr.status === 200) {
              // Redirect to HTML Page 2
              window.location.href = "video-room.html";
            } else {
              console.error("Error sending data to the servlet");
            }
          };

          // Send session data to the servlet
          xhr.send(
            `sessionName=${encodeURIComponent(
              sessionName
            )}&sessionPassword=${encodeURIComponent(
              sessionPassword
            )}&userName=${encodeURIComponent(userName)}`
          );
        } else {
          // Create public room
          const xhr = new XMLHttpRequest();
          xhr.open("POST", "createpublicroom", true);
          xhr.setRequestHeader(
            "Content-Type",
            "application/x-www-form-urlencoded"
          );

          xhr.onload = function () {
            if (xhr.status === 200) {
              // Redirect to HTML Page 2
              window.location.href = "video-room.html";
            } else {
              console.error("Error sending data to the servlet");
            }
          };

          // Send session data to the servlet
          xhr.send(
            `sessionName=${encodeURIComponent(
              sessionName
            )}&userName=${encodeURIComponent(
              userName
            )}&userId=${encodeURIComponent(userId)}`
          );
        }
      }

      // Notifications
      $(document).ready(function () {
        $("#notiBtn").click(function () {
          // Make AJAX request to the servlet
          $.ajax({
            url: "notifications", // Servlet URL
            method: "GET",
            success: function (response) {
              // Clear any existing notifications
              $("#notificationsContainer").empty();

              // Loop through the notifications and display them
              response.forEach(function (notification) {
                $("#notificationsContainer").append(
                  "<p>" +
                    notification.noti_id +
                    " | " +
                    notification.sender_username +
                    " | " +
                    notification.receiver_username +
                    " | " +
                    notification.notification +
                    " (" +
                    notification.status +
                    ")</p>"
                );
              });
            },
            error: function (xhr, status, error) {
              console.error("Error fetching notifications: " + error);
            },
          });
        });
      });
    </script>
  </head>
  <body>
    <h1>Public room</h1>
    <form onsubmit="sendRoomData(event)">
      <label for="sessionName">Session Name:</label>
      <input type="text" id="sessionName" required /><br />
      <label for="sessionPassword">Session Password:</label>
      <input type="password" id="sessionPassword" required /><br />
      <label for="privateRoomCheckBox">Private room</label>
      <input
        type="checkbox"
        id="privateRoomCheckBox"
        name="privateRoomCheckBox"
        value="Private room"
      />
      <button type="submit">Submit</button>
    </form>
    <p id="userName"></p>
    <button id="notiBtn">Notifications</button>
    <div id="notificationsContainer"></div>

    <div>
      <a href="virtual-study-webapp/frontend/pages/main-home.html"
        ><button>Main Page</button></a
      >
    </div>
    <a href="virtual-study-webapp/frontend/pages/main-task.html"
      ><button>Set Tasks</button></a
    >
    <div>
      <a href="virtual-study-webapp/frontend/pages/main-friends.html"
        ><button>Friends</button></a
      >
    </div>
  </body>
</html>
